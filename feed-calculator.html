<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Front Row Ag Â· Feed Calculator</title>
<style>
  :root {
    --bg: #0d0d0d;
    --card: #161616;
    --card-border: #2a2a2a;
    --accent: #3ee6b6;
    --accent-dim: rgba(62,230,182,0.15);
    --text: #e8e8e8;
    --text-dim: #c0c0c0;
    --text-muted: #a0a0a0;
    --input-bg: #1c1c1c;
    --input-border: #3a3a3a;
    --danger: #e63e3e;
    --part-a: #8bb83a;
    --part-b: #4488dd;
    --bloom: #d44040;
    --phoszyme: #d45e78;
    --b-bloom: #8866cc;
    --si: #b8a030;
    --phup: #8855bb;
    --bioflo: #4caf7c;
    --triologic: #d4c040;
  }

  /* â”€â”€ Light Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  body.light {
    --bg: #f5f6f8;
    --card: #ffffff;
    --card-border: #e2e5ea;
    --accent: #1a7a5a;
    --accent-dim: rgba(26,122,90,0.12);
    --text: #1a1d23;
    --text-dim: #5a6069;
    --text-muted: #8b919a;
    --input-bg: #ffffff;
    --input-border: #d0d4da;
    --danger: #c53030;
    --part-a: #4a8a00;
    --part-b: #2266bb;
    --bloom: #bb2020;
    --phoszyme: #b03050;
    --b-bloom: #6644aa;
    --si: #8a7a20;
    --phup: #6644aa;
    --bioflo: #2a8a55;
    --triologic: #9a8520;
  }
  body.light .card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  }
  body.light .stock-table .val-col { background: rgba(26,122,90,0.04); }
  body.light .stock-table td.val-col:last-child,
  body.light .stock-table th.val-col:last-child { border-right-color: rgba(26,122,90,0.25); }
  body.light .stock-table td.val-col-first,
  body.light .stock-table th.val-col-first { border-left-color: rgba(26,122,90,0.25); }
  body.light .stock-table tr:last-child .val-col { border-bottom-color: rgba(26,122,90,0.25); }
  body.light .validation-group-label {
    border-color: rgba(26,122,90,0.25);
    background: rgba(26,122,90,0.04);
  }
  body.light .info-drawer-content {
    background: rgba(26,122,90,0.05);
    border-color: rgba(26,122,90,0.15);
  }
  body.light .toggle-btn.active {
    background: var(--accent);
    color: #fff;
    font-weight: 600;
    border-color: var(--accent);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  /* â”€â”€ Focus States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .toggle-btn:focus-visible,
  .btn:focus-visible,
  .theme-toggle:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px var(--accent-dim);
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.5;
    min-height: 100vh;
    padding: 20px 16px 40px;
    transition: background-color 0.3s, color 0.3s;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    position: relative;
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    text-align: center;
    margin-bottom: 28px;
    padding-top: 8px;
  }
  .header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .header h1 span { color: var(--accent); }
  .header p {
    color: var(--text-dim);
    font-size: 0.85rem;
    margin-top: 4px;
  }

  /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 14px;
    padding: 24px 24px 20px;
    margin-bottom: 16px;
    transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
  }
  .card h2 {
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: 16px;
  }

  /* â”€â”€ Toggle Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toggle-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 6px;
  }
  .toggle-btn {
    background: var(--input-bg);
    color: var(--text);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    padding: 8px 18px;
    font-size: 0.88rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
  }
  .toggle-btn:hover { border-color: var(--accent); }
  .toggle-btn.active {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* â”€â”€ Section Labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-label {
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 12px;
    margin-top: 4px;
  }
  .config-spacer { height: 16px; }

  .facility-row { margin-bottom: 16px; }
  .facility-input {
    width: 100%;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    color: var(--text);
    font-size: 0.88rem;
    padding: 8px 12px;
    font-family: inherit;
  }
  .facility-input::placeholder { color: var(--text-muted); font-size: 0.82rem; }
  .facility-input:focus { outline: none; border-color: var(--accent); }

  /* â”€â”€ Feed Schedule Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .feed-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }
  .feed-table th {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-dim);
    padding: 4px 8px;
    text-align: center;
    border-bottom: none;
  }
  .feed-table th:first-child { text-align: left; }
  .feed-table .header-row-last th {
    padding-bottom: 10px;
    border-bottom: 1px solid var(--card-border);
  }
  .feed-table td {
    padding: 14px 8px;
    text-align: center;
    border-bottom: 1px solid var(--card-border);
    font-size: 0.92rem;
  }
  .feed-table td:first-child {
    text-align: left;
    font-weight: 600;
    font-size: 0.88rem;
  }
  .feed-table tr:last-child td { border-bottom: none; }
  .feed-table tbody tr { transition: background-color 0.15s; }
  .feed-table tbody tr:hover { background: rgba(255,255,255,0.03); }
  body.light .feed-table tbody tr:hover { background: rgba(0,0,0,0.03); }

  .val { font-weight: 600; font-variant-numeric: tabular-nums; font-size: 1.05rem; }
  .val-a { color: var(--part-a); }
  .val-b { color: var(--part-b); }
  .val-bloom { color: var(--bloom); }
  .val-phz { color: var(--phoszyme); }
  .val-total { color: var(--text); }

  .unit-hint {
    font-size: 0.65rem;
    font-weight: 400;
    color: var(--text-muted);
  }
  .ec-sub {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-top: 1px;
    font-variant-numeric: tabular-nums;
  }
  .unit-sub {
    font-size: 0.72rem;
    color: var(--text-muted);
    font-weight: 400;
    margin-left: 2px;
  }

  .phase-ec {
    display: inline-block;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 5px;
    padding: 2px 8px;
    font-size: 0.75rem;
    color: var(--text);
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .component-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }
  .dot-a { background: var(--part-a); }
  .dot-b { background: var(--part-b); }
  .dot-bloom { background: var(--bloom); }
  .dot-phz { background: var(--phoszyme); }
  .val-bbloom { color: var(--b-bloom); }
  .dot-bbloom { background: var(--b-bloom); }

  .dash { color: var(--text-muted); font-weight: 400; }

  .table-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -2px;
    padding: 0 2px;
  }
  @media (max-width: 600px) {
    .table-scroll {
      mask-image: linear-gradient(to right, #000 calc(100% - 20px), transparent);
      -webkit-mask-image: linear-gradient(to right, #000 calc(100% - 20px), transparent);
    }
    .table-scroll:not(.scrolled-end) {
      mask-image: linear-gradient(to right, #000 calc(100% - 20px), transparent);
      -webkit-mask-image: linear-gradient(to right, #000 calc(100% - 20px), transparent);
    }
    .table-scroll.scrolled-end {
      mask-image: none;
      -webkit-mask-image: none;
    }
  }

  .unit-badge {
    font-size: 0.92rem;
    font-weight: 700;
    color: #fff;
    background: var(--accent);
    border-radius: 6px;
    padding: 4px 12px;
    margin-left: 10px;
    vertical-align: middle;
    letter-spacing: 0.02em;
  }

  /* â”€â”€ Custom EC Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ec-input {
    width: 48px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 5px;
    color: var(--text);
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 1px 4px;
    font-family: inherit;
    font-variant-numeric: tabular-nums;
    outline: none;
    transition: border-color 0.15s;
    -moz-appearance: textfield;
  }
  .ec-input::-webkit-inner-spin-button,
  .ec-input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .ec-input:focus {
    border-color: var(--accent);
  }

  .phase-ec.editable {
    background: var(--accent-dim);
    border-color: var(--accent);
    padding: 2px 8px;
    display: inline-flex;
    align-items: center;
    gap: 1px;
  }
  .phase-ec.editable .ec-input {
    background: transparent;
    border: none;
    color: var(--accent);
    width: 32px;
    font-size: 0.75rem;
    padding: 0;
  }
  .phase-ec.editable .ec-input:focus {
    border: none;
  }
  .phase-ec.editable .ec-label {
    color: var(--accent);
    font-size: 0.72rem;
    font-weight: 600;
  }

  /* â”€â”€ Recipe Select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .recipe-select {
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 5px;
    color: var(--text);
    font-size: 0.75rem;
    font-weight: 600;
    font-family: inherit;
    padding: 2px 8px;
    outline: none;
    cursor: pointer;
  }
  .recipe-select:focus {
    border-color: var(--accent);
  }
  .recipe-select.modified {
    color: var(--text);
  }
  .recipe-select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* â”€â”€ Stock Tank Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stock-table {
    width: 100%;
    border-collapse: collapse;
  }
  .stock-table th {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-dim);
    padding: 6px 10px 10px;
    text-align: center;
    border-bottom: 1px solid var(--card-border);
  }
  .stock-table th:first-child, .stock-table th:nth-child(2):not(.validation-group-label) { text-align: left; }
  .stock-table td {
    padding: 12px 10px;
    text-align: center;
    border-bottom: 1px solid var(--card-border);
    font-size: 0.9rem;
    font-variant-numeric: tabular-nums;
  }
  .stock-table td:first-child,
  .stock-table td:nth-child(2) {
    text-align: left;
    font-weight: 600;
    font-size: 0.85rem;
  }
  /* AIDEV-NOTE: PhosZyme sub-row has no tank cell (rowspan from Part B covers it),
     so nth-child shifts â€” reset the 2nd td back to normal data styling */
  .stock-table tr.phz-sub td:nth-child(2) {
    text-align: center;
    font-weight: normal;
    font-size: 0.9rem;
  }
  .stock-table tr:last-child td { border-bottom: none; }
  .validation-ec { color: var(--danger); font-weight: 700; font-size: 1rem; }

  .stock-table .val-col {
    background: rgba(62,230,182,0.03);
  }
  .stock-table td.val-col:last-child,
  .stock-table th.val-col:last-child {
    border-right: 1px solid rgba(62,230,182,0.25);
  }
  .stock-table td.val-col-first,
  .stock-table th.val-col-first {
    border-left: 1px solid rgba(62,230,182,0.25);
  }
  .stock-table tr:last-child .val-col {
    border-bottom: 1px solid rgba(62,230,182,0.25);
  }
  .validation-group-label {
    text-align: center;
    color: var(--accent);
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 8px 10px 2px;
    border-bottom: none !important;
    border-left: 1px solid rgba(62,230,182,0.25);
    border-right: 1px solid rgba(62,230,182,0.25);
    border-top: 1px solid rgba(62,230,182,0.25);
    border-radius: 6px 6px 0 0;
    background: rgba(62,230,182,0.03);
  }
  .validation-group-spacer {
    padding: 0;
    border-bottom: none !important;
  }

  /* â”€â”€ Mixing Instructions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .instructions-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    padding: 2px 0;
    user-select: none;
  }
  .instructions-toggle h2 { margin-bottom: 0; }
  .chevron {
    transition: transform 0.2s;
    color: var(--text-dim);
    font-size: 1.1rem;
  }
  .chevron.open { transform: rotate(180deg); }
  .instructions-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .instructions-body.open { max-height: 300px; }
  .instructions-body ol {
    padding: 14px 0 4px 20px;
    color: var(--text-dim);
    font-size: 0.88rem;
  }
  .instructions-body li {
    margin-bottom: 6px;
    line-height: 1.5;
  }

  /* â”€â”€ Supplemental Products Reference â”€â”€â”€â”€â”€â”€ */
  .supp-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .supp-body.open { max-height: 400px; }
  .supp-list { padding: 14px 0 4px; }
  .supp-item { margin-bottom: 12px; }
  .supp-item:last-child { margin-bottom: 0; }
  .supp-name { font-weight: 600; font-size: 0.88rem; }
  .supp-detail {
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.55;
    margin-top: 2px;
  }

  /* â”€â”€ Bottom Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn-row {
    display: flex;
    gap: 10px;
    margin-top: 18px;
  }
  .btn {
    flex: 1;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-size: 0.88rem;
    font-weight: 500;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn:active { transform: scale(0.98); }
  .btn svg { width: 16px; height: 16px; }
  .copied {
    border-color: var(--accent) !important;
    color: var(--accent) !important;
  }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .footer {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.78rem;
    margin-top: 24px;
    padding-bottom: 12px;
  }
  .footer a { color: var(--accent); text-decoration: none; }
  .footer a:hover { text-decoration: underline; }

  /* â”€â”€ Info Drawers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-label-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    margin-top: 4px;
  }
  .section-label-row .section-label {
    margin: 0;
  }
  .info-btn {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-muted);
    font-size: 0.7rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
    font-family: inherit;
    padding: 0;
    line-height: 1;
  }
  .info-btn:hover,
  .info-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-dim);
  }
  .info-drawer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, margin 0.3s ease;
    margin-bottom: 0;
  }
  .info-drawer.open {
    max-height: 500px;
    margin-bottom: 12px;
  }
  .info-drawer-content {
    background: rgba(62,230,182,0.04);
    border: 1px solid rgba(62,230,182,0.15);
    border-radius: 10px;
    padding: 14px 16px;
    margin-top: 8px;
  }
  .info-drawer-content p {
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.6;
    margin: 0;
  }
  .info-drawer-content p + p {
    margin-top: 10px;
  }
  .info-drawer-content strong {
    color: var(--text);
    font-weight: 600;
  }

  /* â”€â”€ Theme Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .theme-toggle {
    position: absolute;
    top: 12px;
    right: 0;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    padding: 0;
  }
  .theme-toggle:hover { border-color: var(--accent); color: var(--accent); }
  .theme-toggle svg { width: 16px; height: 16px; }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    body { padding: 12px 8px 30px; }
    .card { padding: 16px 14px; }
    .feed-table th, .feed-table td { padding: 10px 4px; font-size: 0.82rem; }
    .val { font-size: 0.95rem; }
    .phase-header { font-size: 0.7rem; }
    .toggle-btn { padding: 7px 12px; font-size: 0.82rem; }
  }

  /* â”€â”€ Print Header (hidden on screen) â”€â”€ */
  .print-header { display: none; }

  /* â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media print {
    @page { margin: 0.4in 0.5in; size: letter; }
    body { background: #fff; color: #000; padding: 0; font-size: 11px; }
    .container { max-width: 100%; padding: 0; }

    /* Kill transitions, shadows, masks in print */
    *, *::before, *::after {
      transition: none !important;
      box-shadow: none !important;
      mask-image: none !important;
      -webkit-mask-image: none !important;
    }

    /* Hide interactive elements */
    .header, #config-card, .btn-row, .footer, .screen-only, .info-drawer { display: none !important; }
    .table-scroll { overflow: visible !important; margin: 0 !important; padding: 0 !important; }
    .instructions-body, .supp-body { overflow: visible !important; }

    /* Show print header */
    .print-header {
      display: block;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #222;
    }
    .print-header-row {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .print-logo {
      height: 42px;
      width: auto;
    }
    .print-header-right { flex: 1; }
    .print-title {
      font-size: 16px;
      font-weight: 700;
      line-height: 1.2;
    }
    .print-facility {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-top: 1px;
    }
    .print-facility:empty { display: none; }
    .print-config {
      font-size: 10px;
      color: #666;
      margin-top: 1px;
    }

    /* Cards: no dark bg, clean borders */
    .card {
      background: #fff;
      border: none;
      border-radius: 0;
      box-shadow: none;
      padding: 6px 0;
      margin-bottom: 4px;
      break-inside: avoid;
    }
    .card h2 { font-size: 13px; color: #000; margin-bottom: 6px; }

    /* Feed table header row labels â€” make first column stand out */
    .feed-table thead th:first-child {
      font-weight: 700;
      color: #000;
      text-align: right;
      padding-right: 10px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      background: #f5f5f5;
    }

    /* Feed table compact */
    .feed-table {
      border-collapse: separate !important;
      border-spacing: 0 !important;
      border: 2px solid #333 !important;
    }
    .feed-table th, .feed-table td {
      padding: 4px 6px; font-size: 11px;
      border: 1px solid #888 !important;
      vertical-align: middle;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .feed-table th { color: #444; }
    .feed-table .header-row-last th { padding-bottom: 4px; }
    .val { font-size: 13px; }
    .ec-sub { font-size: 9px; color: #888; }
    .unit-badge { font-size: 11px; border: none; color: #fff; background: #333; border-radius: 4px; padding: 2px 8px; font-weight: 700; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .phase-ec, .phase-ec.editable { background: none; border: none; color: #000; font-size: 11px; padding: 0; font-weight: 600; }
    .phase-ec.editable .ec-input { color: #000; background: none; border: none; font-size: 11px; }
    .phase-ec.editable .ec-label { color: #000; font-size: 11px; }
    .recipe-select, .recipe-select.modified {
      font-size: 10px; color: #000; font-weight: 600;
      -webkit-appearance: none; appearance: none;
      background: none; border: none; padding: 0;
      pointer-events: none;
      text-align: center; width: 100%;
    }
    .component-dot { width: 6px; height: 6px; }

    /* Keep product colors in print */
    .val-a { color: #4a8a00 !important; }
    .val-b { color: #2266bb !important; }
    .val-bloom { color: #bb2020 !important; }
    .val-phz { color: #b03050 !important; }
    .val-bbloom { color: #6644aa !important; }
    .dot-a { background: #4a8a00 !important; }
    .dot-b { background: #2266bb !important; }
    .dot-bloom { background: #bb2020 !important; }
    .dot-phz { background: #b03050 !important; }
    .dot-bbloom { background: #6644aa !important; }

    /* Stock table compact */
    .stock-table {
      border-collapse: separate !important;
      border-spacing: 0 !important;
      border: 2px solid #333 !important;
    }
    .stock-table th, .stock-table td {
      padding: 4px 6px; font-size: 10px;
      border: 1px solid #888 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .stock-table th { color: #444; }
    .stock-table td[rowspan] { vertical-align: middle; }
    .stock-table tr.phz-sub td:nth-child(2) { text-align: center; font-weight: normal; font-size: 10px; }
    .validation-ec { font-size: 12px; color: #cc2020 !important; }
    .stock-table .val-col { background: #f9f9f9; }
    .validation-group-label {
      background: #f9f9f9;
      border-color: #ccc;
      color: #444;
    }
    .stock-table td.val-col-first,
    .stock-table th.val-col-first { border-left: 1px solid #ccc; }
    .stock-table td.val-col:last-child,
    .stock-table th.val-col:last-child { border-right: 1px solid #ccc; }
    .stock-table tr:last-child .val-col { border-bottom: 1px solid #ccc; }

    /* Validation label centering in print */
    .validation-group-label { text-align: center !important; }

    /* Mixing instructions: always open, compact, no emoji */
    .instructions-body { display: block !important; max-height: none !important; }
    .chevron { display: none; }
    .instructions-toggle { cursor: default; }
    #instructions-card h2 { font-size: 13px; }
    .screen-only { display: none !important; }
    #instructions-list { font-size: 10px; padding-left: 18px; }
    #instructions-list li { margin-bottom: 1px; }

    /* Supplemental products: always open, compact 2-col grid in print */
    .supp-body { display: block !important; max-height: none !important; }
    #supp-card h2 { font-size: 13px; }
    .supp-list {
      display: grid !important;
      grid-template-columns: 1fr 1fr;
      gap: 4px 16px;
      padding: 4px 0 0 !important;
    }
    .supp-item { margin-bottom: 2px !important; }
    .supp-name { font-size: 11px; }
    .supp-detail { font-size: 9px; color: #555; line-height: 1.4; }

    /* PhosZyme footnote */
    #phz-footnote { font-size: 9px; color: #888; margin-top: 4px !important; }

    /* Print footer */
    .print-footer {
      display: block !important;
      text-align: center;
      font-size: 8px;
      color: #aaa;
      margin-top: 8px;
      padding-top: 4px;
      border-top: 1px solid #ddd;
    }

    /* 2-doser tint in print */
    .stock-table tr[style*="rgba(136,102,204"] { background: #f5f3fa !important; }
  }
</style>
</head>
<body>

<div class="container">

  <!-- Theme Toggle (hidden in print) -->
  <button class="theme-toggle screen-only" onclick="toggleTheme()" aria-label="Toggle light/dark mode">
    <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
  </button>

  <!-- Print Header (hidden on screen, shown in print) -->
  <div class="print-header" id="print-header">
    <div class="print-header-row">
      <div class="print-header-left">
        <img src="logo.png" alt="Front Row Ag" class="print-logo">
      </div>
      <div class="print-header-right">
        <div class="print-title">Feed Calculator</div>
        <div class="print-facility" id="print-facility"></div>
        <div class="print-config" id="print-config-line"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <h1><span>Front Row Ag</span> Â· Feed Calculator</h1>
    <p>Stock concentrate mixing rates & feed schedules</p>
  </div>

  <!-- Configuration Card -->
  <div class="card" id="config-card">
    <h2>Configuration</h2>

    <div class="facility-row">
      <input type="text" class="facility-input" id="facility-input" placeholder="Facility name (optional â€” appears on printed chart)" oninput="updateFacility()">
    </div>

    <div class="section-label-row">
      <div class="section-label">Application</div>
      <button class="info-btn" onclick="toggleDrawer('app-drawer', this)" aria-label="What's the difference between stock concentrate and direct to reservoir?">?</button>
    </div>
    <div class="toggle-group" id="app-group">
      <button class="toggle-btn active" data-val="stock">Stock Concentrate</button>
      <button class="toggle-btn" data-val="direct">Direct to Reservoir</button>
    </div>
    <div class="info-drawer" id="app-drawer">
      <div class="info-drawer-content">
        <p><strong>Stock Concentrate</strong> is the standard commercial setup. Fertilizer is pre-mixed into concentrated stock tanks, then injected into the irrigation line by dosing equipment (injectors). The calculator shows how much product to add to each stock tank and the injection rates for your dosers.</p>
        <p><strong>Direct to Reservoir</strong> is for facilities that mix nutrients directly into a reservoir or batch tank at working strength â€” no stock tanks or injectors involved. The calculator shows how much product to add per gallon (or per liter) of final solution.</p>
      </div>
    </div>

    <div id="method-section">
      <div class="config-spacer"></div>
      <div class="section-label-row">
        <div class="section-label">Mixing Method</div>
        <button class="info-btn" onclick="toggleDrawer('method-drawer', this)" aria-label="What do these mixing methods mean?">?</button>
      </div>
      <div class="toggle-group" id="method-group">
        <button class="toggle-btn active" data-val="3-2-2">3-2-2</button>
        <button class="toggle-btn" data-val="1-1-1">1-1-1</button>
      </div>
      <div class="info-drawer" id="method-drawer">
        <div class="info-drawer-content">
          <p><strong>3:2:2</strong> is the standard mixing method. Three 25-pound bags of Part A go into a 50-gallon stock tank (75 lbs total at 1.5 lbs/gal). Part B and Bloom each get two 25-pound bags into 50 gallons (50 lbs each at 1 lb/gal). Because Part A is more concentrated, the injection rates come out equal across all three parts â€” which simplifies day-to-day dosing.</p>
          <p><strong>1:1:1</strong> means everything is mixed at 1 pound per gallon â€” 50 pounds of each part into 50-gallon stock tanks. This is a lower concentration than 3:2:2 and is used by facilities that prefer a uniform weight ratio. Injection rates will differ between parts since each contributes a different share of the total EC.</p>
        </div>
      </div>
      <div class="config-spacer"></div>
      <div class="section-label-row">
        <div class="section-label">Dosers</div>
        <button class="info-btn" onclick="toggleDrawer('doser-drawer', this)" aria-label="What's the difference between 3-doser and 2-doser?">?</button>
      </div>
      <div class="toggle-group" id="doser-group">
        <button class="toggle-btn active" data-val="3">3-Doser</button>
        <button class="toggle-btn" data-val="2">2-Doser</button>
      </div>
      <div class="info-drawer" id="doser-drawer">
        <div class="info-drawer-content">
          <p><strong>3-Doser:</strong> Three separate stock tanks â€” Part A, Part B, and Bloom each get their own injector. This is the standard setup and allows full flexibility with per-phase recipe adjustments.</p>
          <p><strong>2-Doser:</strong> Two stock tanks â€” Part A in one, and Part B + Bloom combined in the other. Used in facilities with only two injectors. Locks all phases to the Stack recipe since the B-to-Bloom ratio is fixed in a single tank.</p>
        </div>
      </div>
    </div>

    <div class="config-spacer"></div>
    <div class="section-label">Output Units</div>
    <div class="toggle-group" id="unit-group"></div>

    <div class="config-spacer"></div>
    <div class="section-label">EC Presets</div>
    <div class="toggle-group" id="ec-preset-group">
      <button class="toggle-btn active" data-val="high">High Strength</button>
      <button class="toggle-btn" data-val="standard">Standard</button>
      <button class="toggle-btn" data-val="custom">Custom</button>
    </div>

    <div class="config-spacer"></div>
    <div class="section-label-row">
      <div class="section-label">Supplements</div>
      <button class="info-btn" onclick="toggleDrawer('supplements-drawer', this)" aria-label="What are these supplements?">?</button>
    </div>
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <button class="toggle-btn active" id="phz-btn" onclick="togglePhz()">+ PhosZyme</button>
      <button class="toggle-btn" id="si-btn" onclick="toggleSi()">+ Si</button>
      <button class="toggle-btn" id="phup-btn" onclick="togglePhUp()">+ pH Up</button>
      <button class="toggle-btn active" id="bioflo-btn" onclick="toggleBioFlo()">+ BioFlo</button>
      <button class="toggle-btn active" id="triologic-btn" onclick="toggleTriologic()">+ Triologic</button>
    </div>
    <div class="info-drawer" id="supplements-drawer">
      <div class="info-drawer-content">
        <p><strong>PhosZyme</strong> is added to the Part B stock tank (or the combined B + Bloom tank in 2-doser mode). It contains phosphorus-digesting enzymes that improve nutrient availability. When enabled, the calculator automatically scales all dosages down slightly so the total EC â€” including PhosZyme's contribution â€” still hits your target. Most facilities include PhosZyme by default.</p>
        <p><strong>Si</strong> is a silica supplement used as a foliar spray at 0.5â€“2 mL/gal, once weekly, from veg through week 3 of flower.</p>
        <p><strong>pH Up</strong> is used as needed to raise pH into the 5.5â€“6.0 target range. Maximum 0.2 g/gal total in the mix. Always add last, after all nutrients are mixed, and allow 5â€“15 minutes of reaction time before re-measuring.</p>
        <p><strong>BioFlo</strong> is a bioenzymatic line cleaner that removes biofilm from irrigation lines, maintaining consistent flow and even nutrient delivery. Not a feed additive â€” used as a periodic soak between or during cycles.</p>
        <p><strong>Triologic</strong> is a microbial inoculant containing Mycorrhization Helper Bacteria. It amplifies mycorrhizal colonization when applied as a weekly hand-water drench alongside a separate mycorrhizal inoculant.</p>
      </div>
    </div>

  </div>

  <!-- Feed Schedule Card -->
  <div class="card">
    <h2>Feed Schedule <span class="unit-badge" id="unit-badge"></span></h2>
    <div class="table-scroll">
    <table class="feed-table" id="feed-table">
      <thead>
        <tr>
          <th style="width:18%">Phase</th>
          <th>Veg / Moms</th>
          <th>Wk 1â€“2</th>
          <th>Wk 3â€“4</th>
          <th>Wk 5â€“7</th>
          <th>Final Wks</th>
        </tr>
        <tr>
          <th>Recipe</th>
          <th><select class="recipe-select" id="recipe-veg" onchange="handleRecipeChange('Veg',this.value)"><option>Veg</option><option>Stretch</option><option>Stack</option><option>Swell</option><option>Ripen</option></select></th>
          <th><select class="recipe-select" id="recipe-stretch" onchange="handleRecipeChange('Stretch',this.value)"><option>Veg</option><option>Stretch</option><option>Stack</option><option>Swell</option><option>Ripen</option></select></th>
          <th><select class="recipe-select" id="recipe-stack" onchange="handleRecipeChange('Stack',this.value)"><option>Veg</option><option>Stretch</option><option>Stack</option><option>Swell</option><option>Ripen</option></select></th>
          <th><select class="recipe-select" id="recipe-swell" onchange="handleRecipeChange('Swell',this.value)"><option>Veg</option><option>Stretch</option><option>Stack</option><option>Swell</option><option>Ripen</option></select></th>
          <th><select class="recipe-select" id="recipe-ripen" onchange="handleRecipeChange('Ripen',this.value)"><option>Veg</option><option>Stretch</option><option>Stack</option><option>Swell</option><option>Ripen</option></select></th>
        </tr>
        <tr class="header-row-last">
          <th>Target EC</th>
          <th><div class="phase-ec" id="ec-veg"></div></th>
          <th><div class="phase-ec" id="ec-stretch"></div></th>
          <th><div class="phase-ec" id="ec-stack"></div></th>
          <th><div class="phase-ec" id="ec-swell"></div></th>
          <th><div class="phase-ec" id="ec-ripen"></div></th>
        </tr>
      </thead>
      <tbody id="feed-body"></tbody>
    </table>
    </div>
    <div class="btn-row">
      <button class="btn" id="btn-copy" onclick="copySummary()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Copy Summary
      </button>
      <button class="btn" id="btn-share" onclick="shareLink()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
        Share Link
      </button>
      <button class="btn" onclick="printPage()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Print / Save PDF
      </button>
    </div>
    <p class="screen-only" style="font-size:0.72rem; color:var(--text-muted); margin-top:8px; text-align:center;">Tip: Choose "Save as PDF" in the print dialog to download a clean one-page PDF.</p>
  </div>

  <!-- Supplemental Products Reference (collapsible) -->
  <div class="card" id="supp-card">
    <div class="instructions-toggle" onclick="toggleSupplements()">
      <h2>Supplemental Products</h2>
      <span class="chevron" id="supp-chevron">â–¾</span>
    </div>
    <div class="supp-body" id="supp-body">
      <div class="supp-list" id="supp-list"></div>
    </div>
  </div>

  <!-- Stock Tank Card -->
  <div class="card" id="stock-card">
    <h2 id="stock-title">Stock Concentrate Rates</h2>
    <div class="table-scroll">
    <table class="stock-table" id="stock-table">
      <thead>
        <tr>
          <th colspan="5" class="validation-group-spacer"></th>
          <th colspan="3" class="validation-group-label">Validation</th>
        </tr>
        <tr>
          <th>Tank</th>
          <th>Part</th>
          <th id="vol-header">gal</th>
          <th id="wt-header">lbs</th>
          <th id="conc-header">lbs/gal</th>
          <th id="sample-header" class="val-col val-col-first">mL / 5gal</th>
          <th id="ec-gal-header" class="val-col">EC/g/gal</th>
          <th class="val-col">Valid. EC</th>
        </tr>
      </thead>
      <tbody id="stock-body"></tbody>
    </table>
    </div>
    <p id="phz-footnote" style="font-size:0.75rem; color:var(--text-dim); margin-top:10px; font-style:italic;">
      * When mixed with Part B stock solution, PhosZyme will increase the validation EC.
    </p>
  </div>

  <!-- Mixing Instructions Card (collapsible) -->
  <div class="card" id="instructions-card">
    <div class="instructions-toggle" onclick="toggleInstructions()">
      <h2><span class="screen-only">ğŸ“‹ </span>Mixing Instructions</h2>
      <span class="chevron" id="chevron">â–¾</span>
    </div>
    <div class="instructions-body" id="instructions-body">
      <ol id="instructions-list"></ol>
    </div>
  </div>

  <div class="footer">
    <a href="https://www.FrontRowAg.com" target="_blank">Front Row Ag</a> Â· Feed Calculator
  </div>

  <!-- Print Footer (hidden on screen, shown in print) -->
  <div class="print-footer" style="display:none;">
    frontrowag.com Â· Generated by Front Row Ag Feed Calculator
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA â€” extracted from Ref sheet
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONSTANTS = {
  g_per_lb: 454,
  mL_per_gal: 3785,
  pct_mult: 100,
  phoszyme_ratio: 0.12,
  L_per_gal: 3.785
};

const EC_PER_GRAM = { partA: 0.322, partB: 0.255, bloom: 0.200, phoszyme: 0.220 };

const STOCK_RATES = {
  "4-3-3": { partA: 1.87, partB: 1.25, bloom: 1.25 },
  "3-2-2": { partA: 1.50, partB: 1.00, bloom: 1.00 },
  "1-1-1": { partA: 1.00, partB: 1.00, bloom: 1.00 }
};

const TANK_VOLUMES = {
  "4-3-3": { tankA: 53.5, tankB: 60 },
  "3-2-2": { tankA: 50, tankB: 50 },
  "1-1-1": { tankA: 50, tankB: 50 }
};

const RECIPES = {
  Veg:     { partA: 0.654471544715447, partB: 0.345528455284553, bloom: 0 },
  Stretch: { partA: 0.55, partB: 0.29, bloom: 0.16 },
  Stack:   { partA: 0.51499, partB: 0.2719123506099, bloom: 0.2130976493901 },
  Swell:   { partA: 0.441, partB: 0.234, bloom: 0.325 },
  Ripen:   { partA: 0.35, partB: 0.30, bloom: 0.35 }
};

const PHASES = ["Veg", "Stretch", "Stack", "Swell", "Ripen"];

const EC_PRESETS = {
  high:     { Veg: 3.0, Stretch: 3.0, Stack: 2.7, Swell: 2.4, Ripen: 1.8 },
  standard: { Veg: 2.6, Stretch: 2.4, Stack: 2.2, Swell: 2.0, Ripen: 1.6 }
};

const UNIT_FACTORS = {
  "g/gal":       1,
  "mL/gal":      CONSTANTS.mL_per_gal / CONSTANTS.g_per_lb,
  "injection %": CONSTANTS.pct_mult / CONSTANTS.g_per_lb,
  "ratio":       "ratio",
  "g/L":         1 / CONSTANTS.L_per_gal,
  "mL/L":        (CONSTANTS.mL_per_gal / CONSTANTS.g_per_lb) / CONSTANTS.L_per_gal
};

const PHOSZYME_FIXED_G_GAL = 0.4;

// Front Row SI: rate (mL/gal) varies inversely with feed EC
// Applied through day 21 of flower (phases: Veg, Stretch, Stack)
const SI_RATE_TABLE = [
  { below: 2.3, rate: 0.5 },
  { below: 2.7, rate: 0.375 },
  { below: 3.1, rate: 0.25 },
  { below: 3.5, rate: 0.125 }
];

// pH Up (Potassium Carbonate): as-needed, small increments
const PHUP_INCREMENT_G_GAL = 0.05;

const STOCK_UNITS  = ["mL/gal", "injection %", "ratio", "mL/L"];
const DIRECT_UNITS = ["g/gal", "g/L"];

const VALID_APPS    = ["stock", "direct"];
const VALID_METHODS = Object.keys(STOCK_RATES);
const VALID_UNITS   = Object.keys(UNIT_FACTORS);
const VALID_PRESETS = ["high", "standard", "custom"];
const VALID_DOSERS  = ["3", "2"];
const VALID_PHZ     = ["yes", "no"];

const INSTRUCTIONS = [
  "Start with clean stock tanks marked at target volume.",
  "Add RO water to 50% of target volume; begin agitating tank.",
  "Add fertilizer over 5 minutes, while continuing to agitate tank.",
  "Add RO water to target volume; mix for 10 more minutes.",
  "Validate and adjust stock tank as necessary."
];

// AIDEV-NOTE: Reservoir instructions are dynamic â€” Part B step changes
// based on PhosZyme toggle, and pH Up step only appears when toggled on.
function getReservoirInstructions(usePhz, usePhUp, met) {
  const steps = [
    "Fill reservoir to target volume; begin agitation.",
    "Add Part A; agitate 3â€“5 minutes.",
    usePhz ? "Add Part B and PhosZyme; agitate 3â€“5 minutes." : "Add Part B; agitate 3â€“5 minutes.",
    "Add Bloom; agitate 3â€“5 minutes.",
    "Adjust pH to target range (5.5â€“6.0). RO or low-EC water typically requires pH up; higher-EC starting water may require pH down.",
    "Validate pH/EC and adjust as necessary."
  ];
  return steps;
}

const INSTRUCTIONS_2DOSER = [
  "Start with two clean stock tanks marked at target volume.",
  "Add RO water to 50% of target volume in each tank; begin agitating.",
  "Tank 1: Add Part A over 5 minutes while agitating.",
  "Tank 2: Add Part B, then Bloom, then PhosZyme over 5 minutes while agitating.",
  "Add RO water to target volume in each tank; mix for 10 more minutes.",
  "Validate and adjust each stock tank as necessary."
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let state = {
  application: "stock",
  method: "3-2-2",
  doserMode: "3",
  usePhoszyme: true,
  showSi: false,
  showPhUp: false,
  showBioFlo: true,
  showTriologic: true,
  unit: "mL/gal",
  ecPreset: "high",
  targetEC: { ...EC_PRESETS.high },
  phaseRecipe: { Veg: "Veg", Stretch: "Stretch", Stack: "Stack", Swell: "Swell", Ripen: "Ripen" }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function isMetric(unit) {
  return unit === "g/L" || unit === "mL/L";
}

function getDecimals(unit) {
  if (unit === "mL/gal") return 0;
  if (unit === "mL/L") return 1;
  if (unit === "g/gal" || unit === "g/L") return 1;
  return 2;
}

function getUnitFactor(unit) {
  if (unit === "ratio") return null;
  return UNIT_FACTORS[unit];
}

function getStockConc(method, component) {
  if (state.application === "direct") return 1;
  return STOCK_RATES[method][component];
}

function getStockConcDisplay(method, component, unit) {
  const base = STOCK_RATES[method][component];
  if (isMetric(unit)) {
    return Math.round(base * CONSTANTS.g_per_lb / CONSTANTS.L_per_gal);
  }
  return base;
}

function getRecipe(phase) {
  return RECIPES[state.phaseRecipe[phase]];
}

// When PhosZyme is included, scale down A/B/Bloom so total (incl. PhZ) = target EC.
// PhosZyme adds overhead proportional to Part B's EC contribution.
function getPhzScaleFactor(phase) {
  if (!state.usePhoszyme) return 1;
  const recipe = getRecipe(phase);
  const phzOverhead = recipe.partB * CONSTANTS.phoszyme_ratio * (EC_PER_GRAM.phoszyme / EC_PER_GRAM.partB);
  return 1 / (1 + phzOverhead);
}

function calcEcContribution(phase, component, targetEC) {
  return getRecipe(phase)[component] * targetEC;
}

function calcDosage(phase, component, method, unit, targetEC) {
  const ecContrib = calcEcContribution(phase, component, targetEC);
  if (ecContrib === 0) return { dosage: 0, ec: 0, display: "â€“" };

  const ecPerG = EC_PER_GRAM[component];
  const stockConc = getStockConc(method, component);

  if (unit === "ratio") {
    const gramsPerGal = ecContrib / ecPerG / stockConc;
    const injPct = gramsPerGal * (CONSTANTS.pct_mult / CONSTANTS.g_per_lb);
    const ratio = Math.round(CONSTANTS.pct_mult / injPct);
    return { dosage: ratio, ec: ecContrib, display: `1:${ratio}` };
  }

  const factor = getUnitFactor(unit);
  const dosage = ecContrib / ecPerG / stockConc * factor;
  const dec = getDecimals(unit);

  return { dosage: +dosage.toFixed(dec), ec: ecContrib, display: dosage.toFixed(dec) };
}

function calcPhoszymeDosage(phase, method, unit, targetEC) {
  const partBResult = calcDosage(phase, "partB", method, unit, targetEC);
  if (partBResult.dosage === 0) return { dosage: 0, ec: 0, display: "â€“" };

  const partBEc = calcEcContribution(phase, "partB", targetEC);
  const phzEc = partBEc * CONSTANTS.phoszyme_ratio * (EC_PER_GRAM.phoszyme / EC_PER_GRAM.partB);

  if (unit === "g/gal" || unit === "g/L") {
    const val = isMetric(unit) ? PHOSZYME_FIXED_G_GAL / CONSTANTS.L_per_gal : PHOSZYME_FIXED_G_GAL;
    return { dosage: +val.toFixed(getDecimals(unit)), ec: phzEc, display: val.toFixed(getDecimals(unit)) };
  }

  return { dosage: partBResult.dosage, ec: phzEc, display: partBResult.display };
}

// Front Row SI: rate in mL/gal based on feed EC (varies inversely)
function calcSiRate(ec) {
  for (const { below, rate } of SI_RATE_TABLE) {
    if (ec < below) return rate;
  }
  if (ec < 3.5) return 0.125;
  return 0;
}

function calcStockTanks(method, unit) {
  const met = isMetric(unit);
  const vols = TANK_VOLUMES[method];
  const rates = STOCK_RATES[method];

  const volA = met ? Math.round(vols.tankA * CONSTANTS.L_per_gal) : vols.tankA;
  const volB = met ? Math.round(vols.tankB * CONSTANTS.L_per_gal) : vols.tankB;

  const wtA = met ? +(volA * getStockConcDisplay(method, "partA", unit) / 1000).toFixed(1) : +(vols.tankA * rates.partA).toFixed(1);
  const wtB = met ? +(volB * getStockConcDisplay(method, "partB", unit) / 1000).toFixed(1) : +(vols.tankB * rates.partB).toFixed(1);
  const wtPhz = +(wtB * CONSTANTS.phoszyme_ratio).toFixed(1);
  const wtBloom = met ? +(volB * getStockConcDisplay(method, "bloom", unit) / 1000).toFixed(1) : +(vols.tankB * rates.bloom).toFixed(1);

  const sampleVol = met ? 400 : 250;

  function ecPerUnit_raw(ecBase) {
    return met ? ecBase * CONSTANTS.L_per_gal : ecBase;
  }

  const concA = getStockConcDisplay(method, "partA", unit);
  const concB = getStockConcDisplay(method, "partB", unit);
  const concPhz = met ? Math.round(concB * CONSTANTS.phoszyme_ratio) : +(concB * CONSTANTS.phoszyme_ratio).toFixed(2);
  const concBloom = getStockConcDisplay(method, "bloom", unit);

  const sampleDilution = met ? 20 : 5;
  function valEC(conc, ecBase) {
    return +(conc * ecPerUnit_raw(ecBase) * (sampleVol / sampleDilution / 1000)).toFixed(2);
  }
  function valEC_imp(rateLbs, ecBase) {
    return +(rateLbs * CONSTANTS.g_per_lb * ecBase * (sampleVol / 5 / CONSTANTS.mL_per_gal)).toFixed(2);
  }

  const valA    = met ? valEC(concA, EC_PER_GRAM.partA)       : valEC_imp(rates.partA, EC_PER_GRAM.partA);
  const valB    = met ? valEC(concB, EC_PER_GRAM.partB)       : valEC_imp(rates.partB, EC_PER_GRAM.partB);
  const valPhz  = met ? valEC(concPhz, EC_PER_GRAM.phoszyme)  : valEC_imp(rates.partB * CONSTANTS.phoszyme_ratio, EC_PER_GRAM.phoszyme);
  const valBlm  = met ? valEC(concBloom, EC_PER_GRAM.bloom)   : valEC_imp(rates.bloom, EC_PER_GRAM.bloom);

  return {
    volUnit: met ? "L" : "gal",
    wtUnit: met ? "kg" : "lbs",
    concUnit: met ? "g / L" : "lbs / gal",
    sampleUnit: met ? "mL / 20L" : "mL / 5gal",
    ecUnit: met ? "EC / g / L" : "EC / g / gal",
    rows: [
      { tank: 1, part: "A",          vol: volA, wt: wtA,    conc: concA,    sample: sampleVol, ecG: met ? ecPerUnit_raw(EC_PER_GRAM.partA).toFixed(3)    : EC_PER_GRAM.partA,    valEC: valA,   cls: "val-a" },
      { tank: 2, part: "B",          vol: volB, wt: wtB,    conc: concB,    sample: sampleVol, ecG: met ? ecPerUnit_raw(EC_PER_GRAM.partB).toFixed(3)    : EC_PER_GRAM.partB,    valEC: valB,   cls: "val-b" },
      { tank: "â€“", part: "PhosZyme*", vol: volB, wt: wtPhz,  conc: concPhz,  sample: sampleVol, ecG: met ? ecPerUnit_raw(EC_PER_GRAM.phoszyme).toFixed(3) : EC_PER_GRAM.phoszyme, valEC: valPhz, cls: "val-phz" },
      { tank: 3, part: "Bloom",      vol: volB, wt: wtBloom, conc: concBloom, sample: sampleVol, ecG: met ? ecPerUnit_raw(EC_PER_GRAM.bloom).toFixed(3)   : EC_PER_GRAM.bloom,   valEC: valBlm, cls: "val-bloom" }
    ]
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function copyToClipboard(text) {
  if (navigator.clipboard && window.isSecureContext) {
    return navigator.clipboard.writeText(text);
  }
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.select();
  document.execCommand("copy");
  document.body.removeChild(ta);
  return Promise.resolve();
}

function copyRichText(html, plain) {
  if (navigator.clipboard && navigator.clipboard.write && window.isSecureContext) {
    return navigator.clipboard.write([
      new ClipboardItem({
        "text/html": new Blob([html], { type: "text/html" }),
        "text/plain": new Blob([plain], { type: "text/plain" })
      })
    ]);
  }
  // Fallback: copy plain text
  return copyToClipboard(plain);
}

function render() {
  const { method, unit, targetEC } = state;
  const isStock = state.application === "stock";
  const is2Doser = state.doserMode === "2";
  const components = [
    { key: "partA", label: "Part A", cls: "val-a", dotCls: "dot-a" },
    { key: "partB", label: "Part B", cls: "val-b", dotCls: "dot-b" },
    { key: "bloom", label: "Bloom", cls: "val-bloom", dotCls: "dot-bloom" },
    { key: "phoszyme", label: "PhosZyme", cls: "val-phz", dotCls: "dot-phz" }
  ];

  // Unit badge
  document.getElementById("unit-badge").textContent = unit === "ratio" ? "ratio" : unit;

  // EC displays
  PHASES.forEach(p => {
    const el = document.getElementById(`ec-${p.toLowerCase()}`);
    el.textContent = `${targetEC[p]} EC`;
    el.classList.remove('editable');
  });

  // Recipe selects â€” locked to Stack in 2-doser mode
  PHASES.forEach(p => {
    const sel = document.getElementById(`recipe-${p.toLowerCase()}`);
    if (is2Doser) {
      sel.value = "Stack";
      sel.disabled = true;
      sel.classList.remove('modified');
    } else {
      sel.disabled = false;
      sel.value = state.phaseRecipe[p];
      sel.classList.toggle('modified', state.phaseRecipe[p] !== p);
    }
  });

  // Feed table body
  let html = "";
  const usePhz = state.usePhoszyme;

  // Helper: render a single feed cell
  function feedCell(display, dosage, ec, cls) {
    if (dosage === 0 || display === "â€“") return `<td><span class="dash">â€“</span></td>`;
    return `<td><div class="val ${cls}">${display}</div><div class="ec-sub">${ec.toFixed(2)} EC</div></td>`;
  }

  // Part A row (always present)
  html += `<tr><td><span class="component-dot dot-a"></span>Part A</td>`;
  PHASES.forEach(phase => {
    const eEC = targetEC[phase] * getPhzScaleFactor(phase);
    const r = calcDosage(phase, "partA", method, unit, eEC);
    html += feedCell(r.display, r.dosage, r.ec, "val-a");
  });
  html += "</tr>";

  if (is2Doser) {
    // â”€â”€ 2-Doser: combined B + Bloom row (+ PhosZyme if included) â”€â”€
    const label = usePhz ? "B + Bloom + PhosZyme" : "B + Bloom";
    html += `<tr><td><span class="component-dot dot-bbloom"></span>${label}</td>`;
    PHASES.forEach(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      const resultB = calcDosage(phase, "partB", method, unit, eEC);
      const bloomEc = calcEcContribution(phase, "bloom", eEC);
      let combinedEc = resultB.ec + bloomEc;
      if (usePhz) {
        combinedEc += calcEcContribution(phase, "partB", eEC) * CONSTANTS.phoszyme_ratio * (EC_PER_GRAM.phoszyme / EC_PER_GRAM.partB);
      }
      html += feedCell(resultB.display, resultB.dosage, combinedEc, "val-bbloom");
    });
    html += "</tr>";

  } else {
    // â”€â”€ 3-Doser â”€â”€
    if (usePhz) {
      // B + PhosZyme combined row
      html += `<tr><td><span class="component-dot dot-b"></span>B + PhosZyme</td>`;
      PHASES.forEach(phase => {
        const eEC = targetEC[phase] * getPhzScaleFactor(phase);
        const resultB = calcDosage(phase, "partB", method, unit, eEC);
        const phzEc = calcEcContribution(phase, "partB", eEC) * CONSTANTS.phoszyme_ratio * (EC_PER_GRAM.phoszyme / EC_PER_GRAM.partB);
        const combinedEc = resultB.ec + phzEc;
        html += feedCell(resultB.display, resultB.dosage, combinedEc, "val-b");
      });
      html += "</tr>";
    } else {
      // Standard Part B row (no PhosZyme)
      html += `<tr><td><span class="component-dot dot-b"></span>Part B</td>`;
      PHASES.forEach(phase => {
        const eEC = targetEC[phase] * getPhzScaleFactor(phase);
        const r = calcDosage(phase, "partB", method, unit, eEC);
        html += feedCell(r.display, r.dosage, r.ec, "val-b");
      });
      html += "</tr>";
    }

    // Bloom row (always in 3-doser)
    html += `<tr><td><span class="component-dot dot-bloom"></span>Bloom</td>`;
    PHASES.forEach(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      const r = calcDosage(phase, "bloom", method, unit, eEC);
      html += feedCell(r.display, r.dosage, r.ec, "val-bloom");
    });
    html += "</tr>";
  }

  document.getElementById("feed-body").innerHTML = html;

  // â”€â”€ Supplemental products reference card â”€â”€
  renderSupplements();

  // Stock tank table (only when stock concentrate)
  if (isStock) {
    const stock = calcStockTanks(method, unit);
    const titlePrefix = is2Doser ? `${method} 2-Doser` : method;
    document.getElementById("stock-title").textContent = `${titlePrefix} Stock Concentrate Rates`;
    document.getElementById("vol-header").textContent = stock.volUnit;
    document.getElementById("wt-header").textContent = stock.wtUnit;
    document.getElementById("conc-header").textContent = stock.concUnit;
    document.getElementById("sample-header").textContent = stock.sampleUnit;
    document.getElementById("ec-gal-header").textContent = stock.ecUnit;

    let stockHtml = "";
    const tank2Parts = usePhz ? ["B", "PhosZyme*", "Bloom"] : ["B", "Bloom"];
    const t2Tint = 'background:rgba(136,102,204,0.06);';
    const t2Border = 'border-left:3px solid var(--b-bloom);';

    // AIDEV-NOTE: When PhosZyme is ON (non-2-doser), Part B's tank cell uses rowspan=2
    // to visually group both products under "Tank 2" with no dividing border.
    stock.rows.forEach((r, i) => {
      // Skip PhosZyme row when PhosZyme is excluded
      if (!usePhz && r.part === "PhosZyme*") return;

      const isTank2 = tank2Parts.includes(r.part);
      // PhosZyme is always a sub-item of Tank 2 (both modes); Bloom only in 2-doser
      const isSubItem = r.part === "PhosZyme*" || (is2Doser && r.part === "Bloom");

      let tankLabel = r.tank;
      let partLabel = r.part;
      const rowStyle = is2Doser && isTank2 ? t2Tint : '';
      const tdStyle = is2Doser && isTank2 ? t2Border : '';

      if (isSubItem) {
        tankLabel = "";
        partLabel = `+ ${r.part}`;
      }

      // Part B row spans 2 rows in the tank column when PhosZyme is included (non-2-doser)
      const bWithPhz = !is2Doser && usePhz && r.part === "B";
      const isPhzSubRow = !is2Doser && r.part === "PhosZyme*";

      let tankCell;
      if (isPhzSubRow) {
        // PhosZyme row: skip tank cell entirely (covered by Part B's rowspan)
        tankCell = "";
      } else if (bWithPhz) {
        // Part B row: span 2 rows, vertically centered, no bottom border
        tankCell = `<td style="${tdStyle}vertical-align:middle" rowspan="2">${tankLabel}</td>`;
      } else {
        tankCell = `<td style="${tdStyle}">${tankLabel}</td>`;
      }

      stockHtml += `<tr style="${rowStyle}"${isPhzSubRow ? ' class="phz-sub"' : ''}>
        ${tankCell}
        <td><span class="${r.cls}" style="font-weight:600">${partLabel}</span></td>
        <td>${r.vol}</td>
        <td>${r.wt}</td>
        <td>${r.conc}</td>
        <td class="val-col val-col-first">${r.sample}</td>
        <td class="val-col">${r.ecG}</td>
        <td class="val-col"><span class="validation-ec">${r.valEC}</span></td>
      </tr>`;
    });

    // In 2-doser mode: add combined Tank 2 validation row
    if (is2Doser) {
      const tank2Rows = stock.rows.filter(r => tank2Parts.includes(r.part));
      const combinedValEC = tank2Rows.reduce((sum, r) => sum + r.valEC, 0).toFixed(2);
      stockHtml += `<tr style="border-top:1px solid var(--card-border);${t2Tint}">
        <td style="${t2Border}"></td>
        <td><span class="val-bbloom" style="font-weight:600">Tank 2 Total</span></td>
        <td></td><td></td><td></td>
        <td class="val-col val-col-first"></td>
        <td class="val-col"></td>
        <td class="val-col"><span class="validation-ec" style="color:var(--b-bloom)">${combinedValEC}</span></td>
      </tr>`;
    }

    document.getElementById("stock-body").innerHTML = stockHtml;

    // PhosZyme footnote â€” update text and visibility
    const footnote = document.getElementById("phz-footnote");
    if (!usePhz) {
      footnote.style.display = "none";
    } else {
      footnote.style.display = "";
      footnote.textContent = is2Doser
        ? "* PhosZyme is mixed into the combined B + Bloom stock tank (Tank 2). The Tank 2 Total reflects all three products."
        : "* When mixed with Part B stock solution, PhosZyme will increase the validation EC.";
    }

    // Mixing instructions (stock mode)
    const instrList = document.getElementById("instructions-list");
    let instrSet;
    if (is2Doser) {
      instrSet = usePhz ? INSTRUCTIONS_2DOSER : INSTRUCTIONS_2DOSER.map(s => s.replace(", then PhosZyme", ""));
    } else {
      instrSet = INSTRUCTIONS;
    }
    instrList.innerHTML = instrSet.map(s => `<li>${s}</li>`).join("");
  } else {
    // Mixing instructions (reservoir mode) â€” updates on every render for toggle/unit changes
    const met = isMetric(state.unit);
    const resInstr = getReservoirInstructions(usePhz, state.showPhUp, met);
    document.getElementById("instructions-list").innerHTML =
      resInstr.map(s => `<li>${s}</li>`).join("");
  }

  // Print config line
  const printParts = [];
  if (isStock) {
    printParts.push(`${method} Stock Concentrate`);
    printParts.push(is2Doser ? "2-Doser" : "3-Doser");
  } else {
    printParts.push("Direct to Reservoir");
  }
  if (usePhz) printParts.push("PhosZyme Included");
  if (state.showSi) printParts.push("Si");
  if (state.showPhUp) printParts.push("pH Up");
  if (state.showBioFlo) printParts.push("BioFlo");
  if (state.showTriologic) printParts.push("Triologic");
  printParts.push(unit);
  document.getElementById("print-config-line").textContent = printParts.join(" Â· ");

  // URL state
  updateURL();

  // Restore custom EC inputs if needed
  if (state.ecPreset === "custom") renderECInputs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI INTERACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setupToggle(groupId, stateKey, callback) {
  const group = document.getElementById(groupId);
  group.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      group.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      if (callback) callback(btn.dataset.val);
      else {
        state[stateKey] = btn.dataset.val;
        render();
      }
    });
  });
}

function rebuildUnitGroup() {
  const units = state.application === "stock" ? STOCK_UNITS : DIRECT_UNITS;
  const group = document.getElementById("unit-group");
  group.innerHTML = units.map(u =>
    `<button class="toggle-btn${u === state.unit ? ' active' : ''}" data-val="${u}">${u}</button>`
  ).join("");
  group.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      group.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      state.unit = btn.dataset.val;
      render();
    });
  });
}

function applyApplicationState() {
  const isStock = state.application === "stock";
  document.getElementById("method-section").style.display = isStock ? "" : "none";
  document.getElementById("stock-card").style.display = isStock ? "" : "none";
  // Reset doser mode when switching to direct
  if (!isStock) state.doserMode = "3";
}

function handleApplicationChange(val) {
  state.application = val;

  // Switch to a valid unit for the new application
  const validUnits = val === "stock" ? STOCK_UNITS : DIRECT_UNITS;
  if (!validUnits.includes(state.unit)) {
    if (isMetric(state.unit)) {
      state.unit = validUnits.find(u => isMetric(u)) || validUnits[0];
    } else {
      state.unit = validUnits.find(u => !isMetric(u)) || validUnits[0];
    }
  }

  applyApplicationState();
  rebuildUnitGroup();
  render();
}

function toggleInstructions() {
  document.getElementById("instructions-body").classList.toggle("open");
  document.getElementById("chevron").classList.toggle("open");
}

function toggleSupplements() {
  document.getElementById("supp-body").classList.toggle("open");
  document.getElementById("supp-chevron").classList.toggle("open");
}

function renderSupplements() {
  const met = isMetric(state.unit);
  let html = "";

  // Si â€” shown when toggled on
  if (state.showSi) {
    const foliarRate = met ? "0.13â€“0.53 mL/L" : "0.5â€“2 mL/gal";
    html += `<div class="supp-item">
      <div class="supp-name" style="color:var(--si)">Si</div>
      <div class="supp-detail">Foliar: ${foliarRate}, once weekly, veg through week 3 of flower.</div>
    </div>`;
  }

  // pH Up â€” shown when toggled on
  if (state.showPhUp) {
    const maxRate = met ? (0.2 / CONSTANTS.L_per_gal).toFixed(2) : "0.2";
    const phupUnit = met ? "g/L" : "g/gal";
    html += `<div class="supp-item">
      <div class="supp-name" style="color:var(--phup)">pH Up</div>
      <div class="supp-detail">Target pH 5.5â€“6.0. As needed, ${maxRate} ${phupUnit} max total. Always add last.</div>
    </div>`;
  }

  // BioFlo â€” shown when toggled on
  if (state.showBioFlo) {
    const heavyRate = met ? "8 mL/L" : "30 mL/gal";
    const maintRate = met ? "4 mL/L" : "15 mL/gal";
    html += `<div class="supp-item">
      <div class="supp-name" style="color:var(--bioflo)">BioFlo</div>
      <div class="supp-detail">Line cleaner for biofilm removal. Heavy clean: ${heavyRate}, soak 8â€“24 hrs. Maintenance: ${maintRate} every 1â€“2 weeks.</div>
    </div>`;
  }

  // Triologic â€” shown when toggled on
  if (state.showTriologic) {
    const stdRate = met ? "0.25 mL/L" : "1 mL/gal";
    const txRate = met ? "0.5 mL/L" : "2 mL/gal";
    html += `<div class="supp-item">
      <div class="supp-name" style="color:var(--triologic)">Triologic</div>
      <div class="supp-detail">Microbial inoculant â€” amplifies mycorrhizal colonization. ${stdRate} weekly hand drench. Transplant: ${txRate}.</div>
    </div>`;
  }

  document.getElementById("supp-list").innerHTML = html;
}

function toggleDrawer(drawerId, btn) {
  const drawer = document.getElementById(drawerId);
  drawer.classList.toggle("open");
  btn.classList.toggle("active");
}

function handleECPreset(val) {
  state.ecPreset = val;
  if (val === "high" || val === "standard") {
    state.targetEC = { ...EC_PRESETS[val] };
  }
  render();
}

function handleRecipeChange(phase, recipeName) {
  state.phaseRecipe[phase] = recipeName;
  render();
}

function handleDoserChange(val) {
  state.doserMode = val;
  if (val === "2") {
    // Lock all phases to Stack recipe
    PHASES.forEach(p => state.phaseRecipe[p] = "Stack");
  }
  render();
}

function updateFacility() {
  const val = document.getElementById("facility-input").value.trim();
  document.getElementById("print-facility").textContent = val;
  updateURL();
}

function togglePhz() {
  state.usePhoszyme = !state.usePhoszyme;
  document.getElementById("phz-btn").classList.toggle("active", state.usePhoszyme);
  render();
}

function toggleSi() {
  state.showSi = !state.showSi;
  document.getElementById("si-btn").classList.toggle("active", state.showSi);
  render();
}

function togglePhUp() {
  state.showPhUp = !state.showPhUp;
  document.getElementById("phup-btn").classList.toggle("active", state.showPhUp);
  render();
}

function toggleBioFlo() {
  state.showBioFlo = !state.showBioFlo;
  document.getElementById("bioflo-btn").classList.toggle("active", state.showBioFlo);
  render();
}

function toggleTriologic() {
  state.showTriologic = !state.showTriologic;
  document.getElementById("triologic-btn").classList.toggle("active", state.showTriologic);
  render();
}

function renderECInputs() {
  PHASES.forEach(p => {
    const el = document.getElementById(`ec-${p.toLowerCase()}`);
    if (state.ecPreset === "custom") {
      el.classList.add('editable');
      el.innerHTML = `<input type="number" class="ec-input" step="0.1" min="0" max="10" value="${state.targetEC[p]}"
        onchange="state.targetEC['${p}']=parseFloat(this.value)||0; render();" /><span class="ec-label">EC</span>`;
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL STATE (Share Link)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateURL() {
  const p = new URLSearchParams();
  if (document.body.classList.contains('light')) p.set("t", "light");
  const fac = document.getElementById("facility-input").value.trim();
  if (fac) p.set("fac", fac);
  p.set("a", state.application);
  if (state.application === "stock") {
    p.set("m", state.method);
    if (state.doserMode === "2") p.set("d", "2");
  }
  if (!state.usePhoszyme) p.set("phz", "no");
  if (state.showSi) p.set("si", "yes");
  if (state.showPhUp) p.set("phup", "yes");
  if (!state.showBioFlo) p.set("bf", "no");
  if (!state.showTriologic) p.set("tri", "no");
  p.set("u", state.unit);
  p.set("p", state.ecPreset);
  if (state.ecPreset === "custom") {
    PHASES.forEach(ph => p.set(`ec_${ph.toLowerCase()}`, state.targetEC[ph]));
  }
  PHASES.forEach(ph => {
    if (state.phaseRecipe[ph] !== ph) p.set(`rp_${ph.toLowerCase()}`, state.phaseRecipe[ph]);
  });
  history.replaceState(null, "", "?" + p.toString());
}

function loadFromURL() {
  const p = new URLSearchParams(window.location.search);
  if (p.has("fac")) {
    document.getElementById("facility-input").value = p.get("fac");
    document.getElementById("print-facility").textContent = p.get("fac");
  }
  if (p.has("a") && VALID_APPS.includes(p.get("a"))) state.application = p.get("a");
  if (p.has("m") && VALID_METHODS.includes(p.get("m"))) state.method = p.get("m");
  if (p.has("d") && VALID_DOSERS.includes(p.get("d"))) {
    state.doserMode = p.get("d");
    if (state.doserMode === "2") PHASES.forEach(ph => state.phaseRecipe[ph] = "Stack");
  }
  if (p.has("phz") && VALID_PHZ.includes(p.get("phz"))) {
    state.usePhoszyme = (p.get("phz") !== "no");
  }
  if (p.get("si") === "yes") state.showSi = true;
  if (p.get("phup") === "yes") state.showPhUp = true;
  if (p.get("bf") === "no") state.showBioFlo = false;
  if (p.get("tri") === "no") state.showTriologic = false;
  if (p.has("u") && VALID_UNITS.includes(p.get("u"))) state.unit = p.get("u");
  if (p.has("p") && VALID_PRESETS.includes(p.get("p"))) {
    state.ecPreset = p.get("p");
    if (state.ecPreset === "high" || state.ecPreset === "standard") {
      state.targetEC = { ...EC_PRESETS[state.ecPreset] };
    } else if (state.ecPreset === "custom") {
      PHASES.forEach(ph => {
        const v = parseFloat(p.get(`ec_${ph.toLowerCase()}`));
        if (v > 0 && v <= 10) state.targetEC[ph] = v;
      });
    }
  }
  PHASES.forEach(ph => {
    const rp = p.get(`rp_${ph.toLowerCase()}`);
    if (rp && PHASES.includes(rp)) state.phaseRecipe[ph] = rp;
  });
  // Validate unit against application
  const validUnits = state.application === "stock" ? STOCK_UNITS : DIRECT_UNITS;
  if (!validUnits.includes(state.unit)) {
    state.unit = validUnits[0];
  }
}

function syncToggleButtons() {
  document.querySelectorAll("#app-group .toggle-btn").forEach(b => {
    b.classList.toggle("active", b.dataset.val === state.application);
  });
  document.querySelectorAll("#method-group .toggle-btn").forEach(b => {
    b.classList.toggle("active", b.dataset.val === state.method);
  });
  document.querySelectorAll("#doser-group .toggle-btn").forEach(b => {
    b.classList.toggle("active", b.dataset.val === state.doserMode);
  });
  document.getElementById("phz-btn").classList.toggle("active", state.usePhoszyme);
  document.getElementById("si-btn").classList.toggle("active", state.showSi);
  document.getElementById("phup-btn").classList.toggle("active", state.showPhUp);
  document.getElementById("bioflo-btn").classList.toggle("active", state.showBioFlo);
  document.getElementById("triologic-btn").classList.toggle("active", state.showTriologic);
  document.querySelectorAll("#ec-preset-group .toggle-btn").forEach(b => {
    b.classList.toggle("active", b.dataset.val === state.ecPreset);
  });
}

function shareLink() {
  const url = window.location.href;
  copyToClipboard(url).then(() => {
    const btn = document.getElementById("btn-share");
    btn.classList.add("copied");
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!`;
    setTimeout(() => {
      btn.classList.remove("copied");
      btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Share Link`;
    }, 2000);
  });
}

function printPage() {
  window.print();
}

function copySummary() {
  const { method, unit, targetEC } = state;
  const isStock = state.application === "stock";
  const is2Doser = state.doserMode === "2";
  const usePhz = state.usePhoszyme;
  const phaseLabels = ["Veg / Moms", "Wk 1â€“2", "Wk 3â€“4", "Wk 5â€“7", "Final Wks"];

  const ts = 'style="border:1px solid #ccc;padding:6px 10px;text-align:center;"';
  const th = 'style="border:1px solid #ccc;padding:6px 10px;text-align:center;background:#f5f5f5;font-weight:600;"';
  const tl = 'style="border:1px solid #ccc;padding:6px 10px;text-align:left;font-weight:600;"';

  // â”€â”€ Config summary â”€â”€
  let configParts = [];
  if (isStock) {
    configParts.push(`${method} stock concentrate`);
    configParts.push(is2Doser ? "2-Doser" : "3-Doser");
  } else {
    configParts.push("Direct to reservoir");
  }
  if (usePhz) configParts.push("PhosZyme included");
  if (state.showSi) configParts.push("Si");
  if (state.showPhUp) configParts.push("pH Up");
  if (state.showBioFlo) configParts.push("BioFlo");
  if (state.showTriologic) configParts.push("Triologic");
  configParts.push(unit);

  let html = `<h2 style="margin:0 0 4px;">Front Row Ag Feed Chart</h2>`;
  html += `<p style="color:#666;margin:0 0 12px;">${configParts.join(" Â· ")}</p>`;

  // â”€â”€ Feed Schedule Table â”€â”€
  html += `<h3 style="margin:16px 0 6px;">Feed Schedule (${unit})</h3>`;
  html += `<table style="border-collapse:collapse;font-size:14px;">`;

  // Phase header row
  html += `<tr><th ${th}>Phase</th>`;
  phaseLabels.forEach(l => html += `<th ${th}>${l}</th>`);
  html += `</tr>`;

  // Recipe row
  html += `<tr><td ${tl}>Recipe</td>`;
  PHASES.forEach(p => {
    const recipe = is2Doser ? "Stack" : state.phaseRecipe[p];
    html += `<td ${ts}>${recipe}</td>`;
  });
  html += `</tr>`;

  // Target EC row
  html += `<tr><td ${tl}>Target EC</td>`;
  PHASES.forEach(p => html += `<td ${ts}><b>${targetEC[p]}</b></td>`);
  html += `</tr>`;

  // Part A row
  html += `<tr><td ${tl}>Part A</td>`;
  PHASES.forEach(phase => {
    const eEC = targetEC[phase] * getPhzScaleFactor(phase);
    const r = calcDosage(phase, "partA", method, unit, eEC);
    html += `<td ${ts}>${r.display}</td>`;
  });
  html += `</tr>`;

  if (is2Doser) {
    // Combined B + Bloom row
    const lbl = usePhz ? "B + Bloom + PhosZyme" : "B + Bloom";
    html += `<tr><td ${tl}>${lbl}</td>`;
    PHASES.forEach(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      const resultB = calcDosage(phase, "partB", method, unit, eEC);
      html += `<td ${ts}>${resultB.display}</td>`;
    });
    html += `</tr>`;
  } else {
    // Part B row (or B + PhosZyme)
    const bLbl = usePhz ? "B + PhosZyme" : "Part B";
    html += `<tr><td ${tl}>${bLbl}</td>`;
    PHASES.forEach(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      const resultB = calcDosage(phase, "partB", method, unit, eEC);
      html += `<td ${ts}>${resultB.display}</td>`;
    });
    html += `</tr>`;

    // Bloom row
    html += `<tr><td ${tl}>Bloom</td>`;
    PHASES.forEach(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      const r = calcDosage(phase, "bloom", method, unit, eEC);
      html += `<td ${ts}>${r.display}</td>`;
    });
    html += `</tr>`;
  }

  html += `</table>`;

  // Supplements section (copy summary)
  const anySupp = state.showSi || state.showPhUp || state.showBioFlo || state.showTriologic;
  if (anySupp) {
    const met = isMetric(unit);
    html += `<p style="margin:12px 0 4px;font-size:13px;font-weight:600;">Supplements</p>`;
    if (state.showSi) {
      const foliarRate = met ? "0.13â€“0.53 mL/L" : "0.5â€“2 mL/gal";
      html += `<p style="margin:2px 0;font-size:13px;">Si â€” Foliar: ${foliarRate}, once weekly, veg through week 3 of flower.</p>`;
    }
    if (state.showPhUp) {
      const maxRate = met ? (0.2 / CONSTANTS.L_per_gal).toFixed(2) : "0.2";
      const phupUnit = met ? "g/L" : "g/gal";
      html += `<p style="margin:2px 0;font-size:13px;">pH Up â€” As needed, ${maxRate} ${phupUnit} max total. Always add last.</p>`;
    }
    if (state.showBioFlo) {
      const heavyRate = met ? "8 mL/L" : "30 mL/gal";
      const maintRate = met ? "4 mL/L" : "15 mL/gal";
      html += `<p style="margin:2px 0;font-size:13px;">BioFlo â€” Heavy clean: ${heavyRate}. Maintenance: ${maintRate} every 1â€“2 weeks.</p>`;
    }
    if (state.showTriologic) {
      const stdRate = met ? "0.25 mL/L" : "1 mL/gal";
      html += `<p style="margin:2px 0;font-size:13px;">Triologic â€” ${stdRate} weekly hand drench.</p>`;
    }
  }

  // â”€â”€ Stock Concentrate Table (stock mode only) â”€â”€
  if (isStock) {
    const stock = calcStockTanks(method, unit);
    const titlePrefix = is2Doser ? `${method} 2-Doser` : method;
    html += `<h3 style="margin:20px 0 6px;">${titlePrefix} Stock Concentrate Rates</h3>`;
    html += `<table style="border-collapse:collapse;font-size:14px;">`;
    html += `<tr><th ${th}>Tank</th><th ${th}>Part</th><th ${th}>${stock.volUnit}</th><th ${th}>${stock.wtUnit}</th><th ${th}>${stock.concUnit}</th>`;
    html += `<th ${th}>${stock.sampleUnit}</th><th ${th}>${stock.ecUnit}</th><th ${th}>Valid. EC</th></tr>`;

    const tank2Parts = usePhz ? ["B", "PhosZyme*", "Bloom"] : ["B", "Bloom"];
    stock.rows.forEach(r => {
      if (!usePhz && r.part === "PhosZyme*") return;
      let tankLabel = r.tank;
      const isSubItem = is2Doser && (r.part === "PhosZyme*" || r.part === "Bloom");
      // Non-2-doser: PhosZyme is a sub-item of Tank 2
      const isPhzSub = !is2Doser && r.part === "PhosZyme*";
      if (is2Doser && isSubItem) tankLabel = "";
      if (isPhzSub) tankLabel = "";
      const partLabel = (isSubItem || isPhzSub) ? `+ ${r.part}` : r.part;
      const bg = is2Doser && tank2Parts.includes(r.part) ? 'background:#f9f7fd;' : '';

      // Rowspan for Part B when PhosZyme included (non-2-doser)
      const bWithPhz = !is2Doser && usePhz && r.part === "B";
      let tankCell;
      if (isPhzSub) {
        tankCell = "";
      } else if (bWithPhz) {
        tankCell = `<td ${ts} rowspan="2" style="vertical-align:middle;border-bottom:none;padding:6px 10px;text-align:center;">${tankLabel}</td>`;
      } else {
        tankCell = `<td ${ts}>${tankLabel}</td>`;
      }

      html += `<tr style="${bg}">${tankCell}<td ${tl}>${partLabel}</td>`;
      html += `<td ${ts}>${r.vol}</td><td ${ts}>${r.wt}</td><td ${ts}>${r.conc}</td>`;
      html += `<td ${ts}>${r.sample}</td><td ${ts}>${r.ecG}</td>`;
      html += `<td ${ts}><b>${r.valEC}</b></td></tr>`;
    });

    // Tank 2 Total row for 2-doser
    if (is2Doser) {
      const tank2Rows = stock.rows.filter(r => tank2Parts.includes(r.part));
      const combinedValEC = tank2Rows.reduce((sum, r) => sum + r.valEC, 0).toFixed(2);
      html += `<tr style="background:#f9f7fd;"><td ${ts}></td><td ${tl}><b>Tank 2 Total</b></td>`;
      html += `<td ${ts}></td><td ${ts}></td><td ${ts}></td><td ${ts}></td><td ${ts}></td>`;
      html += `<td ${ts}><b>${combinedValEC}</b></td></tr>`;
    }
    html += `</table>`;

    if (usePhz) {
      const note = is2Doser
        ? "PhosZyme is mixed into the combined B + Bloom stock tank (Tank 2)."
        : "PhosZyme is mixed into the Part B stock tank. It will increase the validation EC.";
      html += `<p style="font-size:12px;color:#888;margin-top:6px;font-style:italic;">* ${note}</p>`;
    }

    // â”€â”€ Mixing Instructions â”€â”€
    let instrSet;
    if (is2Doser) {
      instrSet = usePhz ? INSTRUCTIONS_2DOSER : INSTRUCTIONS_2DOSER.map(s => s.replace(", then PhosZyme", ""));
    } else {
      instrSet = INSTRUCTIONS;
    }
    html += `<h3 style="margin:20px 0 6px;">Mixing Instructions</h3>`;
    html += `<ol style="font-size:14px;padding-left:20px;">`;
    instrSet.forEach(s => html += `<li style="margin-bottom:4px;">${s}</li>`);
    html += `</ol>`;
  } else {
    // Direct to Reservoir mixing instructions
    html += `<h3 style="margin:20px 0 6px;">Mixing Instructions</h3>`;
    html += `<ol style="font-size:14px;padding-left:20px;">`;
    getReservoirInstructions(usePhz, state.showPhUp, met).forEach(s => html += `<li style="margin-bottom:4px;">${s}</li>`);
    html += `</ol>`;
  }

  html += `<p style="font-size:11px;color:#aaa;margin-top:16px;">Generated by Front Row Ag Feed Calculator</p>`;

  // â”€â”€ Plain text fallback â”€â”€
  let plain = `Front Row Ag Feed Chart\n${configParts.join(" Â· ")}\n${"â”€".repeat(50)}\n\n`;
  plain += "".padEnd(20) + phaseLabels.map(l => l.padEnd(12)).join("") + "\n";
  plain += "Target EC".padEnd(20) + PHASES.map(p => `${targetEC[p]}`.padEnd(12)).join("") + "\n\n";
  plain += "Part A".padEnd(20) + PHASES.map(phase => {
    const eEC = targetEC[phase] * getPhzScaleFactor(phase);
    return calcDosage(phase, "partA", method, unit, eEC).display.padEnd(12);
  }).join("") + "\n";

  if (is2Doser) {
    const lbl = usePhz ? "B+Bloom+PhZ" : "B + Bloom";
    plain += lbl.padEnd(20) + PHASES.map(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      return calcDosage(phase, "partB", method, unit, eEC).display.padEnd(12);
    }).join("") + "\n";
  } else {
    const bLbl = usePhz ? "B + PhosZyme" : "Part B";
    plain += bLbl.padEnd(20) + PHASES.map(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      return calcDosage(phase, "partB", method, unit, eEC).display.padEnd(12);
    }).join("") + "\n";
    plain += "Bloom".padEnd(20) + PHASES.map(phase => {
      const eEC = targetEC[phase] * getPhzScaleFactor(phase);
      return calcDosage(phase, "bloom", method, unit, eEC).display.padEnd(12);
    }).join("") + "\n";
  }

  if (state.showSi || state.showPhUp || state.showBioFlo || state.showTriologic) {
    const met = isMetric(unit);
    plain += "\nSupplements\n";
    if (state.showSi) {
      const foliarRate = met ? "0.13â€“0.53 mL/L" : "0.5â€“2 mL/gal";
      plain += `Si â€” Foliar: ${foliarRate}, once weekly, veg through week 3 of flower.\n`;
    }
    if (state.showPhUp) {
      const maxRate = met ? (0.2 / CONSTANTS.L_per_gal).toFixed(2) + " g/L" : "0.2 g/gal";
      plain += `pH Up â€” As needed, ${maxRate} max total. Always add last.\n`;
    }
    if (state.showBioFlo) {
      const heavyRate = met ? "8 mL/L" : "30 mL/gal";
      const maintRate = met ? "4 mL/L" : "15 mL/gal";
      plain += `BioFlo â€” Heavy clean: ${heavyRate}. Maintenance: ${maintRate} every 1â€“2 weeks.\n`;
    }
    if (state.showTriologic) {
      const stdRate = met ? "0.25 mL/L" : "1 mL/gal";
      plain += `Triologic â€” ${stdRate} weekly hand drench.\n`;
    }
  }

  copyRichText(html, plain).then(() => {
    const btn = document.getElementById("btn-copy");
    btn.classList.add("copied");
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!`;
    setTimeout(() => {
      btn.classList.remove("copied");
      btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy Summary`;
    }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ICON_SUN = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
const ICON_MOON = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';

function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('fra-feed-theme', isLight ? 'light' : 'dark');
  document.getElementById('theme-icon').innerHTML = isLight ? ICON_MOON : ICON_SUN;
  updateURL();
}

function loadTheme() {
  const p = new URLSearchParams(window.location.search);
  const urlTheme = p.get('t');
  const savedTheme = localStorage.getItem('fra-feed-theme');
  const theme = urlTheme || savedTheme || 'dark';
  if (theme === 'light') {
    document.body.classList.add('light');
    document.getElementById('theme-icon').innerHTML = ICON_MOON;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

setupToggle("app-group", null, handleApplicationChange);
setupToggle("method-group", "method");
setupToggle("doser-group", null, handleDoserChange);
setupToggle("ec-preset-group", null, handleECPreset);
loadTheme();
loadFromURL();
syncToggleButtons();
applyApplicationState();
rebuildUnitGroup();
render();

// Scroll hint: remove fade when scrolled to end
document.querySelectorAll('.table-scroll').forEach(el => {
  el.addEventListener('scroll', () => {
    const atEnd = el.scrollLeft + el.clientWidth >= el.scrollWidth - 2;
    el.classList.toggle('scrolled-end', atEnd);
  });
});
</script>

</body>
</html>
